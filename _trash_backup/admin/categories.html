<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroWatch - Categories</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <style>
        :root {
            --font-family: 'Outfit', sans-serif;
            --sidebar-width: 260px;
        }

        body {
            font-family: var(--font-family);
            background-color: #f8f9fa;
        }

        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: #fff;
            border-right: 1px solid #eee;
            padding: 20px;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 30px;
        }

        .table-img {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <a href="dashboard.html"><strong>AeroWatch</strong></a>
        <hr>
        <a href="categories.html" class="d-block mb-2 fw-bold">Categories</a>
    </div>

    <div class="main-content">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold m-0">Categories</h4>
            <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                <i class="bi bi-plus-lg"></i> Add Category
            </button>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <table class="table align-middle table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Total Products</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="categoryTableBody"></tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- ADD CATEGORY MODAL -->
    <div class="modal fade" id="addCategoryModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Add Category</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="categoryName" class="form-control mb-3"
                        placeholder="Category name" required>
                    <select id="categoryStatus" class="form-select">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-dark" onclick="addCategory()">Save</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {

            let categories = [];
            const tableBody = document.getElementById("categoryTableBody");

            /* LOAD CATEGORIES */
            async function loadCategories() {
                try {
                    const res = await fetch("/api/categories");
                    const data = await res.json();
                    categories = data;
                    renderCategories();
                } catch (error) {
                    console.error("Load error:", error);
                }
            }

            /* RENDER */
            function renderCategories() {
                tableBody.innerHTML = "";

                if (categories.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center py-3">
                                No categories found
                            </td>
                        </tr>`;
                    return;
                }

                categories.forEach(cat => {
                    const row = document.createElement("tr");

                    row.innerHTML = `
                        <td>${cat.name}</td>
                        <td>${cat.productCount || 0}</td>
                        <td>
                            <input type="checkbox"
                                ${cat.status === "Active" ? "checked" : ""}
                                onchange="toggleStatus('${cat._id}', this.checked)">
                            ${cat.status}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger"
                                onclick="deleteCategory('${cat._id}')">
                                Delete
                            </button>
                        </td>
                    `;

                    tableBody.appendChild(row);
                });
            }

            /* ADD */
            window.addCategory = async function () {
                const name = document.getElementById("categoryName").value.trim();
                const status = document.getElementById("categoryStatus").value;

                if (!name) {
                    alert("Enter category name");
                    return;
                }

                try {
                    const res = await fetch("/api/categories", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ name, status })
                    });

                    const data = await res.json();

                    if (!res.ok) {
                        alert(data.message);
                        return;
                    }

                    bootstrap.Modal.getInstance(
                        document.getElementById("addCategoryModal")
                    ).hide();

                    document.getElementById("categoryName").value = "";
                    loadCategories();

                } catch (error) {
                    console.error("Add error:", error);
                }
            };

            /* DELETE */
            window.deleteCategory = async function (id) {
                if (!confirm("Delete this category?")) return;

                try {
                    const res = await fetch(`/api/categories/${id}`, {
                        method: "DELETE"
                    });

                    const data = await res.json();

                    if (!res.ok) {
                        alert(data.message);
                        return;
                    }

                    loadCategories();

                } catch (error) {
                    console.error("Delete error:", error);
                }
            };

            /* STATUS */
            window.toggleStatus = async function (id, checked) {
                const status = checked ? "Active" : "Inactive";

                try {
                    await fetch(`/api/categories/status/${id}`, {
                        method: "PATCH",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ status })
                    });

                    loadCategories();

                } catch (error) {
                    console.error("Status error:", error);
                }
            };

            loadCategories();
        });
    </script>

</body>
</html>
